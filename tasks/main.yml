---
- name: Register information about the /vagrant directory.
  stat:
    path: /vagrant
  register: vagrant_directory

- name: Create or restore site database
  include: mysql.yml
  when: wp_mysql_enable

- name: Ensure that installation directory exists
  file:
    path: "{{wp_install_dir}}"
    state: directory

- name: Deploy WordPress if configured.
  include: tasks/deploy.yml
  when: wp_deploy

- name: Get information about index.php.
  stat:
    path: "{{ wp_install_dir }}/index.php"
  register: index_file

- name: Download {{wp_version}} to {{ workspace }}.
  get_url:
    url: "http://wordpress.org/wordpress-{{wp_version}}.tar.gz"
    force: no
    dest: "{{ workspace }}/wordpress-{{wp_version}}.tar.gz"
  when: install_wordpress | default(False) and not index_file.stat.exists

- name: Extract archive.
  unarchive:
    src: "{{ workspace }}/wordpress-{{wp_version}}.tar.gz"
    dest: "{{ workspace }}"
    copy: no
    extra_opts: "--no-same-owner"
  creates: "{{ workspace }}/wordpress/index.php"
  when: install_wordpress | default(False) and not index_file.stat.exists

- name: Move extracted files to {{wp_install_dir}}.
  synchronize:
    src: "{{ workspace }}/wordpress/"
    dest: "{{ wp_install_dir }}/"
    archive: True
  delegate_to: "{{ inventory_hostname }}"
  creates: "{{ wp_install_dir }}/index.php"

#- name: Remove wordpress-{{wp_version}}.tar.gz
#  file:
#    path: "{{ workspace }}/wordpress-{{wp_version}}.tar.gz"
#    state: absent
#  when: install_wordpress | default(False)

- name: Fetch random salts for wp-config.php
  command: curl https://api.wordpress.org/secret-key/1.1/salt/
  register: 'wp_salt'

- name: Copy wp-config.php file
  template:
    src: wp-config.php.j2
    dest: "{{wp_install_dir}}/wp-config.php"

- name: Change ownership of installation directory
  file:
    path: "{{wp_install_dir}}"
    owner: "{{ (vagrant_directory.stat.gr_name == 'vagrant_group') | ternary(omit, wp_core_owner) }}"
    group: "{{ (vagrant_directory.stat.gr_name == 'vagrant_group') | ternary(omit, wp_core_owner) }}"
    mode: 0775
    state: directory
    recurse: yes

- name: Change ownership of uploads directory
  file:
    path: "{{wp_install_dir}}/wp-content/uploads/"
    owner: "{{ (vagrant_directory.stat.gr_name == 'vagrant_group') | ternary(omit, wp_core_owner) }}"
    group: "{{ (vagrant_directory.stat.gr_name == 'vagrant_group') | ternary(omit, drupalvm_webserver_user) }}"
    state: directory
    recurse: yes
